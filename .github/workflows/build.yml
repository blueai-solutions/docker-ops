name: ðŸš€ Build e Testes - BlueAI Docker Ops

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  SYSTEM_NAME: "BlueAI Docker Ops"
  VERSION: ${{ github.ref_name }}

jobs:
  # ðŸ”§ ValidaÃ§Ã£o e Testes
  validate:
    name: ðŸ” ValidaÃ§Ã£o e Testes
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ³ Configurar Docker
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ”§ Configurar Bash
        run: |
          echo "Configurando ambiente bash..."
          echo "Bash version: $(bash --version)"
          echo "Shell: $SHELL"
          
      - name: ðŸ“‹ Verificar estrutura do projeto
        run: |
          echo "ðŸ“ Estrutura do projeto:"
          find . -type f -name "*.sh" | head -20
          echo ""
          echo "ðŸ“Š EstatÃ­sticas:"
          echo "Scripts bash: $(find . -name "*.sh" | wc -l)"
          echo "Arquivos markdown: $(find . -name "*.md" | wc -l)"
          echo "Arquivos de config: $(find . -name "*.sh" -path "*/config/*" | wc -l)"
          
      - name: âœ… Validar sintaxe bash
        run: |
          echo "ðŸ” Validando sintaxe bash..."
          find . -name "*.sh" -exec bash -n {} \;
          echo "âœ… Todos os scripts bash tÃªm sintaxe vÃ¡lida!"
          
      - name: ðŸ” Verificar permissÃµes
        run: |
          echo "ðŸ” Verificando permissÃµes..."
          find . -name "*.sh" -exec ls -la {} \;
          
      - name: ðŸ§ª Testes bÃ¡sicos do sistema
        run: |
          echo "ðŸ§ª Executando testes bÃ¡sicos..."
          
          # Testar script principal
          if [ -f "./blueai-docker-ops.sh" ]; then
            echo "âœ… Script principal encontrado"
            ./blueai-docker-ops.sh --help > /dev/null 2>&1 && echo "âœ… Script principal executÃ¡vel" || echo "âŒ Script principal com problemas"
          fi
          
          # Testar scripts de instalaÃ§Ã£o
          if [ -f "./install/install.sh" ]; then
            echo "âœ… Script de instalaÃ§Ã£o encontrado"
            ./install/install.sh --help > /dev/null 2>&1 && echo "âœ… Script de instalaÃ§Ã£o executÃ¡vel" || echo "âŒ Script de instalaÃ§Ã£o com problemas"
          fi
          
          # Testar configuraÃ§Ãµes
          if [ -f "./config/version-config.sh" ]; then
            echo "âœ… ConfiguraÃ§Ã£o de versÃ£o encontrada"
            source ./config/version-config.sh
            echo "ðŸ“‹ Sistema: $SYSTEM_NAME"
            echo "ðŸ“‹ VersÃ£o: $VERSION"
          fi
          
      - name: ðŸ“Š RelatÃ³rio de qualidade
        run: |
          echo "ðŸ“Š RELATÃ“RIO DE QUALIDADE"
          echo "=========================="
          echo "âœ… Sintaxe bash: VÃ¡lida"
          echo "âœ… Estrutura: Organizada"
          echo "âœ… Scripts: ExecutÃ¡veis"
          echo "âœ… ConfiguraÃ§Ãµes: Carregadas"
          echo "ðŸŽ¯ Sistema: $SYSTEM_NAME"
          echo "ðŸ“‹ VersÃ£o: $VERSION"
          
      - name: ðŸŽ¯ Status final
        run: |
          echo "ðŸŽ‰ BUILD CONCLUÃDO COM SUCESSO!"
          echo "ðŸš€ BlueAI Docker Ops estÃ¡ pronto para distribuiÃ§Ã£o!"

  # ðŸ“¦ PreparaÃ§Ã£o para Release
  prepare-release:
    name: ðŸ“¦ PreparaÃ§Ã£o para Release
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ·ï¸ Obter versÃ£o atual
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ VersÃ£o atual: $VERSION"
          
      - name: ðŸ“‹ Criar release notes
        run: |
          echo "ðŸ“‹ Gerando release notes dinÃ¢micos..."
          
          # Sourcing da configuraÃ§Ã£o
          source config/version-config.sh
          
          # Criar release notes dinÃ¢micos
          cat > RELEASE_NOTES.md << EOF
          # ðŸš€ Release ${{ steps.version.outputs.version }}
          
          ## ðŸ“‹ InformaÃ§Ãµes do Sistema
          
          **Nome:** $SYSTEM_NAME  
          **VersÃ£o:** ${{ steps.version.outputs.version }}  
          **Autor:** $SYSTEM_AUTHOR  
          **LicenÃ§a:** $SYSTEM_LICENSE  
          **DescriÃ§Ã£o:** $SYSTEM_DESCRIPTION
          
          ## âœ¨ Funcionalidades Principais
          
          ### ðŸ”„ Sistema de Backup e RecuperaÃ§Ã£o
          - Backup dinÃ¢mico de containers Docker
          - RecuperaÃ§Ã£o automÃ¡tica com priorizaÃ§Ã£o
          - Sistema de agendamento inteligente
          
          ### ðŸ”§ ConfiguraÃ§Ã£o e InstalaÃ§Ã£o
          - InstalaÃ§Ã£o automÃ¡tica e manual
          - Sistema de templates para configuraÃ§Ã£o
          - ConfiguraÃ§Ã£o interativa e automÃ¡tica
          
          ### ðŸ“Š Monitoramento e NotificaÃ§Ãµes
          - Logs estruturados e relatÃ³rios HTML
          - NotificaÃ§Ãµes macOS e email
          - Sistema de monitoramento em tempo real
          
          ## ðŸ—ï¸ Arquitetura Organizada
          
          ### ðŸ“ Estrutura de Scripts
          - **Core:** Funcionalidades principais do sistema
          - **Backup:** Sistema de backup dinÃ¢mico
          - **Notifications:** Sistema de notificaÃ§Ãµes
          - **Logging:** Sistema de logs avanÃ§ados
          - **Utils:** UtilitÃ¡rios para usuÃ¡rios finais
          - **Install:** Scripts de instalaÃ§Ã£o
          
          ### ðŸ”’ SeguranÃ§a e DistribuiÃ§Ã£o
          - Templates limpos para distribuiÃ§Ã£o
          - ConfiguraÃ§Ãµes locais preservadas
          - Pacotes otimizados para usuÃ¡rios finais
          
          ## ðŸš€ InstalaÃ§Ã£o
          
          ### âš¡ InstalaÃ§Ã£o AutomÃ¡tica
          \`\`\`bash
          curl -sSL https://raw.githubusercontent.com/blueai-solutions/docker-ops/main/install/install.sh | bash
          \`\`\`
          
          ### ðŸ”§ InstalaÃ§Ã£o Manual
          \`\`\`bash
          git clone https://github.com/blueai-solutions/docker-ops.git
          cd docker-ops/backend
          ./scripts/utils/config-setup.sh --interactive
          \`\`\`
          
          ## ðŸ“š DocumentaÃ§Ã£o
          
          - **ðŸ“– Guia de InÃ­cio RÃ¡pido:** [docs/guia-inicio-rapido.md](docs/guia-inicio-rapido.md)
          - **ðŸ”§ Comandos:** [docs/comandos.md](docs/comandos.md)
          - **ðŸ—ï¸ Arquitetura:** [docs/arquitetura.md](docs/arquitetura.md)
          - **ðŸš€ LaunchAgent:** [docs/launchagent.md](docs/launchagent.md)
          - **ðŸ†˜ SoluÃ§Ã£o de Problemas:** [docs/solucao-problemas.md](docs/solucao-problemas.md)
          
          ## ðŸ†˜ Suporte
          
          - **ðŸ“§ Email:** docker-ops@blueaisolutions.com.br
          - **ðŸ› Issues:** https://github.com/blueai-solutions/docker-ops/issues
          - **ðŸ“– DocumentaÃ§Ã£o:** https://github.com/blueai-solutions/docker-ops/tree/main/docs
          
          ---
          
          **Desenvolvido com â¤ï¸ pela $SYSTEM_AUTHOR**
          EOF
          
          echo "âœ… Release notes dinÃ¢micos criados!"
          echo "ðŸ“‹ ConteÃºdo baseado em: $SYSTEM_NAME v${{ steps.version.outputs.version }}"
          
      - name: ðŸ“¤ Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          
      - name: ðŸŽ¯ Status de preparaÃ§Ã£o
        run: |
          echo "ðŸ“¦ RELEASE PREPARADO!"
          echo "ðŸ·ï¸ VersÃ£o: ${{ steps.version.outputs.version }}"
          echo "ðŸ“‹ Notas: RELEASE_NOTES.md"
