name: ğŸš€ Release AutomÃ¡tico - BlueAI Docker Ops

on:
  push:
    tags:
      - 'v*'

env:
  SYSTEM_NAME: "BlueAI Docker Ops"

jobs:
  # ğŸ·ï¸ Criar Release
  create-release:
    name: ğŸ·ï¸ Criar Release
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Obter informaÃ§Ãµes da tag
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Tag: $TAG_NAME"
          echo "ğŸ“‹ VersÃ£o: ${TAG_NAME#v}"
          
      - name: ğŸ“‹ Gerar release notes
        id: release_notes
        run: |
          echo "ğŸ“‹ Gerando release notes..."
          
          # Obter commits desde a Ãºltima tag
          if [ "${{ steps.tag.outputs.tag_name }}" != "v0.0.0" ]; then
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "v0.0.0")
            echo "ğŸ“‹ Tag anterior: $PREVIOUS_TAG"
            
            # Gerar changelog
            echo "## ğŸš€ Release ${{ steps.tag.outputs.tag_name }}" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "### ğŸ“… Data: $(date '+%d/%m/%Y')" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "### âœ¨ Novidades" >> RELEASE_NOTES.md
            git log --oneline --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20 >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "### ğŸ”§ Melhorias TÃ©cnicas" >> RELEASE_NOTES.md
            echo "- Sistema de CI/CD com GitHub Actions" >> RELEASE_NOTES.md
            echo "- Releases automÃ¡ticos" >> RELEASE_NOTES.md
            echo "- Estrutura organizada e profissional" >> RELEASE_NOTES.md
          else
            # Primeira release
            echo "## ğŸš€ Primeira Release - ${{ steps.tag.outputs.tag_name }}" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "### ğŸ“… Data: $(date '+%d/%m/%Y')" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "### âœ¨ LanÃ§amento Inicial" >> RELEASE_NOTES.md
            echo "- Sistema completo de backup Docker" >> RELEASE_NOTES.md
            echo "- RecuperaÃ§Ã£o automÃ¡tica de containers" >> RELEASE_NOTES.md
            echo "- Sistema de notificaÃ§Ãµes avanÃ§ado" >> RELEASE_NOTES.md
            echo "- Interface interativa de configuraÃ§Ã£o" >> RELEASE_NOTES.md
            echo "- Logs estruturados e relatÃ³rios HTML" >> RELEASE_NOTES.md
            echo "- LaunchAgent para macOS" >> RELEASE_NOTES.md
            echo "- Sistema de instalaÃ§Ã£o automÃ¡tica" >> RELEASE_NOTES.md
          fi
          
          # Adicionar informaÃ§Ãµes de instalaÃ§Ã£o
          echo "" >> RELEASE_NOTES.md
          echo "### ğŸš€ InstalaÃ§Ã£o" >> RELEASE_NOTES.md
          echo "```bash" >> RELEASE_NOTES.md
          echo "# InstalaÃ§Ã£o automÃ¡tica" >> RELEASE_NOTES.md
          echo "curl -sSL https://raw.githubusercontent.com/blueai-solutions/docker-ops/main/install/install.sh | bash" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "# Download manual" >> RELEASE_NOTES.md
          echo "curl -O https://raw.githubusercontent.com/blueai-solutions/docker-ops/main/install/install.sh" >> RELEASE_NOTES.md
          echo "chmod +x install.sh" >> RELEASE_NOTES.md
          echo "./install.sh" >> RELEASE_NOTES.md
          echo "```" >> RELEASE_NOTES.md
          
          # Adicionar informaÃ§Ãµes de suporte
          echo "" >> RELEASE_NOTES.md
          echo "### ğŸ†˜ Suporte" >> RELEASE_NOTES.md
          echo "- ğŸ“– [DocumentaÃ§Ã£o](https://github.com/blueai-solutions/docker-ops/tree/main/docs)" >> RELEASE_NOTES.md
          echo "- ğŸ› [Issues](https://github.com/blueai-solutions/docker-ops/issues)" >> RELEASE_NOTES.md
          echo "- ğŸ“§ Email: docker-ops@blueaisolutions.com.br" >> RELEASE_NOTES.md
          
          # Salvar conteÃºdo para uso posterior
          RELEASE_CONTENT=$(cat RELEASE_NOTES.md)
          echo "release_content<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Release notes gerados com sucesso!"
          
      - name: ğŸ·ï¸ Criar Release no GitHub
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          release_name: "ğŸš€ ${{ steps.tag.outputs.tag_name }} - ${{ env.SYSTEM_NAME }}"
          body: ${{ steps.release_notes.outputs.release_content }}
          draft: false
          prerelease: false
          
      - name: ğŸ“¤ Upload assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./RELEASE_NOTES.md
          asset_name: RELEASE_NOTES.md
          asset_content_type: text/markdown
          
      - name: ğŸ¯ Status final
        run: |
          echo "ğŸ‰ RELEASE CRIADO COM SUCESSO!"
          echo "ğŸ·ï¸ Tag: ${{ steps.tag.outputs.tag_name }}"
          echo "ğŸ“‹ VersÃ£o: ${{ steps.tag.outputs.tag_version }}"
          echo "ğŸš€ BlueAI Docker Ops estÃ¡ disponÃ­vel para download!"
