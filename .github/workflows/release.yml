name: ğŸš€ Release Completo - BlueAI Docker Ops

on:
  push:
    tags:
      - 'v*'

env:
  SYSTEM_NAME: "BlueAI Docker Ops"

jobs:
  # ğŸš€ Release Completo (Criar + Deploy)
  release:
    name: ğŸš€ Release Completo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Obter informaÃ§Ãµes da tag
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Tag: $TAG_NAME"
          echo "ğŸ“‹ VersÃ£o: ${TAG_NAME#v}"
          
      - name: ğŸ“‹ Gerar release notes do changelog
        run: |
          echo "ğŸ“‹ Gerando release notes do changelog..."
          
          # ConfiguraÃ§Ãµes do sistema (definidas diretamente)
          SYSTEM_NAME="BlueAI Docker Ops"
          SYSTEM_DESCRIPTION="Sistema automatizado de backup para containers Docker"
          SYSTEM_AUTHOR="BlueAI Solutions"
          SYSTEM_LICENSE="MIT"
          
          RELEASE_VERSION="${{ steps.tag.outputs.tag_version }}"
          CHANGELOG_FILE="docs/changelog/v${RELEASE_VERSION}.md"
          
          if [ -f "$CHANGELOG_FILE" ]; then
            echo "âœ… Usando changelog existente: $CHANGELOG_FILE"
            
            # Cria release notes com cabeÃ§alho do sistema
            {
              echo "# Release Notes - $SYSTEM_NAME v${RELEASE_VERSION}"
              echo ""
              echo "**$SYSTEM_NAME** - $SYSTEM_DESCRIPTION"
              echo "**Autor:** $SYSTEM_AUTHOR"
              echo "**LicenÃ§a:** $SYSTEM_LICENSE"
              echo ""
              echo "---"
              echo ""
              # Remove o cabeÃ§alho do changelog (primeira linha) e adiciona o conteÃºdo
              tail -n +2 "$CHANGELOG_FILE"
            } > RELEASE_NOTES.md
            
          else
            echo "âš ï¸ Changelog nÃ£o encontrado para v${RELEASE_VERSION}"
            echo "ğŸ“ Gerando conteÃºdo padrÃ£o..."
            
            {
              echo "# Release Notes - $SYSTEM_NAME v${RELEASE_VERSION}"
              echo ""
              echo "## Sobre"
              echo "**$SYSTEM_NAME** - $SYSTEM_DESCRIPTION"
              echo "**Autor:** $SYSTEM_AUTHOR"
              echo "**LicenÃ§a:** $SYSTEM_LICENSE"
              echo ""
              echo "## ğŸ“‹ InformaÃ§Ãµes da Release"
              echo "Esta release foi criada automaticamente."
              echo "Para detalhes completos das mudanÃ§as, consulte o [changelog completo](https://github.com/blueai-solutions/docker-ops/blob/main/docs/changelog/CHANGELOG.md)."
              echo ""
              echo "## ğŸš€ Funcionalidades Principais"
              echo "- Sistema de backup automatizado para containers Docker"
              echo "- RecuperaÃ§Ã£o inteligente de volumes e dados"
              echo "- NotificaÃ§Ãµes por email e macOS"
              echo "- Agendamento flexÃ­vel de backups"
              echo "- Interface de linha de comando intuitiva"
            } > RELEASE_NOTES.md
          fi
          
          echo "âœ… Release notes criados!"
          echo "ğŸ“‹ ConteÃºdo baseado em: $SYSTEM_NAME v${RELEASE_VERSION}"
          
      - name: ğŸ·ï¸ Criar Release no GitHub
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "ğŸš€ ${{ steps.tag.outputs.tag_name }} - ${{ env.SYSTEM_NAME }}"
          body_path: ./RELEASE_NOTES.md
          files: |
            ./RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”§ Preparar arquivos de distribuiÃ§Ã£o
        run: |
          echo "ğŸ”§ Preparando arquivos para distribuiÃ§Ã£o..."
          
          mkdir -p dist
          
          # Scripts essenciais para usuÃ¡rios finais
          cp -r scripts/core/ dist/scripts/
          cp -r scripts/backup/ dist/scripts/
          cp -r scripts/notifications/ dist/scripts/
          cp -r scripts/logging/ dist/scripts/
          
          # UtilitÃ¡rios para usuÃ¡rios (excluindo desenvolvimento)
          mkdir -p dist/scripts/utils
          cp scripts/utils/container-configurator.sh dist/scripts/utils/
          cp scripts/utils/recovery-configurator.sh dist/scripts/utils/
          cp scripts/utils/test-system.sh dist/scripts/utils/
          cp scripts/utils/config-backup-manager.sh dist/scripts/utils/
          cp scripts/utils/cleanup-deprecated.sh dist/scripts/utils/
          
          # Scripts de instalaÃ§Ã£o para usuÃ¡rios
          mkdir -p dist/scripts/install
          cp scripts/install/install-launchagent.sh dist/scripts/install/
          
          # Templates de configuraÃ§Ã£o (NÃƒO configuraÃ§Ãµes locais)
          mkdir -p dist/config
          cp -r config/templates/ dist/config/
          
          # DocumentaÃ§Ã£o de uso (excluindo desenvolvimento)
          mkdir -p dist/docs
          cp docs/README.md dist/docs/
          cp docs/guia-inicio-rapido.md dist/docs/
          cp docs/comandos.md dist/docs/
          cp docs/arquitetura.md dist/docs/
          cp docs/solucao-problemas.md dist/docs/
          cp docs/launchagent.md dist/docs/
          
          # Changelog para usuÃ¡rios (apenas histÃ³rico)
          if [ -d "docs/changelog" ]; then
            mkdir -p dist/docs/changelog
            cp docs/changelog/CHANGELOG.md dist/docs/changelog/
            cp docs/changelog/v*.md dist/docs/changelog/ 2>/dev/null || true
          fi
          
          # Scripts de instalaÃ§Ã£o do sistema
          cp -r install/ dist/
          
          # Arquivos principais
          cp blueai-docker-ops.sh dist/
          cp VERSION dist/
          cp README.md dist/
          
          echo "ğŸ“ Estrutura de distribuiÃ§Ã£o:"
          find dist/ -type f | head -20
          
      - name: ğŸ“¦ Criar arquivo compactado
        run: |
          echo "ğŸ“¦ Criando arquivo compactado..."
          
          cd dist
          tar -czf "../blueai-docker-ops-${{ steps.tag.outputs.tag_version }}.tar.gz" .
          cd ..
          
          echo "ğŸ“¦ Arquivo criado: blueai-docker-ops-${{ steps.tag.outputs.tag_version }}.tar.gz"
          
      - name: ğŸ“¤ Upload pacote para release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          files: |
            ./blueai-docker-ops-${{ steps.tag.outputs.tag_version }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ¯ Status final
        run: |
          echo "ğŸ‰ RELEASE COMPLETO COM SUCESSO!"
          echo "ğŸ·ï¸ Tag: ${{ steps.tag.outputs.tag_name }}"
          echo "ğŸ“‹ VersÃ£o: ${{ steps.tag.outputs.tag_version }}"
          echo "ğŸ“¦ Pacote: blueai-docker-ops-${{ steps.tag.outputs.tag_version }}.tar.gz"
          echo "ğŸš€ BlueAI Docker Ops estÃ¡ disponÃ­vel para download!"
