name: ğŸš€ Deploy e DistribuiÃ§Ã£o - BlueAI Docker Ops

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  SYSTEM_NAME: "BlueAI Docker Ops"

jobs:
  prepare-distribution:
    name: ğŸ“¦ Preparar DistribuiÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Obter informaÃ§Ãµes da release
        id: release
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_TAG=${{ github.event.release.tag_name }}
            RELEASE_VERSION=${RELEASE_TAG#v}
          else
            RELEASE_TAG="v$(cat VERSION)"
            RELEASE_VERSION=$(cat VERSION)
          fi
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Release: $RELEASE_TAG"
          echo "ğŸ“‹ VersÃ£o: $RELEASE_VERSION"
          
      - name: ğŸ”§ Preparar arquivos de distribuiÃ§Ã£o
        run: |
          echo "ğŸ”§ Preparando arquivos para distribuiÃ§Ã£o..."
          
          mkdir -p dist
          
          # Scripts essenciais para usuÃ¡rios finais
          cp -r scripts/core/ dist/scripts/
          cp -r scripts/backup/ dist/scripts/
          cp -r scripts/notifications/ dist/scripts/
          cp -r scripts/logging/ dist/scripts/
          
          # UtilitÃ¡rios para usuÃ¡rios (excluindo desenvolvimento)
          mkdir -p dist/scripts/utils
          cp scripts/utils/container-configurator.sh dist/scripts/utils/
          cp scripts/utils/recovery-configurator.sh dist/scripts/utils/
          cp scripts/utils/test-system.sh dist/scripts/utils/
          cp scripts/utils/config-backup-manager.sh dist/scripts/utils/
          cp scripts/utils/cleanup-deprecated.sh dist/scripts/utils/
          
          # Scripts de instalaÃ§Ã£o para usuÃ¡rios
          mkdir -p dist/scripts/install
          cp scripts/install/install-launchagent.sh dist/scripts/install/
          
          # Templates de configuraÃ§Ã£o (NÃƒO configuraÃ§Ãµes locais)
          mkdir -p dist/config
          cp -r config/templates/ dist/config/
          
          # DocumentaÃ§Ã£o de uso (excluindo desenvolvimento)
          mkdir -p dist/docs
          cp docs/README.md dist/docs/
          cp docs/guia-inicio-rapido.md dist/docs/
          cp docs/comandos.md dist/docs/
          cp docs/arquitetura.md dist/docs/
          cp docs/solucao-problemas.md dist/docs/
          cp docs/launchagent.md dist/docs/
          
          # Changelog para usuÃ¡rios (apenas histÃ³rico)
          if [ -d "docs/changelog" ]; then
            mkdir -p dist/docs/changelog
            cp docs/changelog/CHANGELOG.md dist/docs/changelog/
            cp docs/changelog/v*.md dist/docs/changelog/ 2>/dev/null || true
          fi
          
          # Scripts de instalaÃ§Ã£o do sistema
          cp -r install/ dist/
          
          # Arquivos principais
          cp blueai-docker-ops.sh dist/
          cp VERSION dist/
          cp README.md dist/
          
          echo "ğŸ“ Estrutura de distribuiÃ§Ã£o:"
          find dist/ -type f | head -20
          
      - name: ğŸ“¦ Criar arquivo compactado
        run: |
          echo "ğŸ“¦ Criando arquivo compactado..."
          
          cd dist
          tar -czf "../blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz" .
          cd ..
          
          echo "ğŸ“¦ Arquivo criado: blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz"
          
      - name: ğŸ“¤ Upload assets para release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz
          asset_name: blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz
          asset_content_type: application/gzip
          
      - name: ğŸ“Š RelatÃ³rio de distribuiÃ§Ã£o
        run: |
          # Sourcing da configuraÃ§Ã£o
          source config/version-config.sh
          
          echo "ğŸ“Š RELATÃ“RIO DE DISTRIBUIÃ‡ÃƒO"
          echo "============================="
          echo "ğŸ·ï¸ Release: ${{ steps.release.outputs.release_tag }}"
          echo "ğŸ“‹ VersÃ£o: ${{ steps.release.outputs.release_version }}"
          echo "ğŸ“‹ Sistema: $SYSTEM_NAME"
          echo "ğŸ“‹ Autor: $SYSTEM_AUTHOR"
          echo "ğŸ“ Arquivos: $(find dist/ -type f | wc -l)"
          echo "ğŸ“¦ Compactado: blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz"
          echo ""
          echo "ğŸ“‹ CONTEÃšDO INCLUÃDO:"
          echo "âœ… Scripts de uso (core, backup, notifications, logging)"
          echo "âœ… UtilitÃ¡rios para usuÃ¡rios (configuraÃ§Ã£o, recuperaÃ§Ã£o, testes)"
          echo "âœ… Scripts de instalaÃ§Ã£o (LaunchAgent)"
          echo "âœ… Templates de configuraÃ§Ã£o (NÃƒO configuraÃ§Ãµes locais)"
          echo "âœ… DocumentaÃ§Ã£o de uso"
          echo "âœ… Scripts de instalaÃ§Ã£o do sistema"
          echo "âœ… Script de configuraÃ§Ã£o automÃ¡tica"
          echo ""
          echo "âŒ EXCLUÃDO (desenvolvimento e local):"
          echo "âŒ Scripts de release management (scripts/dev/)"
          echo "âŒ Scripts de changelog management (scripts/dev/)"
          echo "âŒ Scripts de version management (scripts/dev/)"
          echo "âŒ ConfiguraÃ§Ãµes especÃ­ficas do ambiente local"
          echo "âŒ DocumentaÃ§Ã£o tÃ©cnica de desenvolvimento"
          echo "âŒ Workflows do GitHub Actions"
          echo "âŒ Makefile (ferramenta de desenvolvimento)"
          
      - name: ğŸ¯ Status final
        run: |
          # Sourcing da configuraÃ§Ã£o
          source config/version-config.sh
          
          echo "ğŸ‰ DISTRIBUIÃ‡ÃƒO PREPARADA COM SUCESSO!"
          echo "ğŸš€ $SYSTEM_NAME v${{ steps.release.outputs.release_version }} estÃ¡ pronto!"
          echo "ğŸ“¦ Arquivo: blueai-docker-ops-${{ steps.release.outputs.release_version }}.tar.gz"
          echo ""
          echo "ğŸ¯ PACOTE OTIMIZADO PARA USUÃRIOS FINAIS"
          echo "ğŸ“š Scripts de desenvolvimento disponÃ­veis apenas no repositÃ³rio"
          echo "ğŸ—ï¸ Estrutura organizada por funcionalidade"
          echo "ğŸ”’ CONFIGURAÃ‡Ã•ES LIMPAS - Sem informaÃ§Ãµes locais!"
          echo "ğŸ‘¨â€ğŸ’» Desenvolvido com â¤ï¸ pela $SYSTEM_AUTHOR"
